<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagrama de Caja y Bigotes Interactivo</title>
    <!-- 1. Importar la librería Plotly.js desde un CDN -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            display: flex;
            flex-direction: column; /* Alineación vertical */
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            box-sizing: border-box;
        }
        .chart-container {
            width: 100%;
            max-width: 950px;
            padding: 25px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        #gemini-button {
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background: linear-gradient(45deg, #4f46e5, #818cf8);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #gemini-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        #gemini-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #gemini-response {
            width: 100%;
            max-width: 950px;
            margin-top: 20px;
            padding: 25px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            white-space: pre-wrap; /* Respeta saltos de línea y espacios */
            line-height: 1.6;
            color: #333;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none; /* Oculto por defecto */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="chart-container">
        <h1>Distribución de Notas por Materia</h1>
        <!-- 2. Este es el contenedor donde se dibujará el gráfico -->
        <div id="boxPlot"></div>
    </div>

    <!-- Botón para llamar a la API de Gemini -->
    <button id="gemini-button">✨ Analisi Adimenduna Sortu</button>
    
    <!-- Contenedor para la respuesta de Gemini y el loader -->
    <div id="loader" class="loader"></div>
    <div id="gemini-response"></div>

    <script>
        // 3. Definir los datos completos de todas las materias
        const lectura =    [59, 61, 63, 54, 58, 54, 48, 47, 42, 52, 53, 50, 45, 43, 48, 42, 38, 39, 37, 38, 33];
        const matematica = [68, 60, 66, 60, 42, 48, 35, 46, 40, 32, 36, 47, 41, 44, 36, 33, 49, 40, 27, 38, 32];
        const sociales =   [50, 62, 51, 52, 45, 40, 46, 42, 44, 37, 33, 38, 33, 31, 34, 43, 29, 35, 39, 31, 39];
        const cienciasN =  [55, 54, 52, 43, 53, 47, 52, 43, 41, 46, 43, 35, 44, 45, 39, 38, 36, 32, 39, 35, 36];
        const ingles =     [71, 48, 62, 27, 46, 40, 53, 46, 49, 41, 42, 28, 39, 30, 40, 28, 30, 38, 43, 31, 30];
        
        // 4. Crear un "trace" (una capa de datos) para cada materia, incluyendo la media
        var trace1 = { y: lectura,    type: 'box', name: 'Lectura',    boxpoints: 'all', jitter: 0.3, pointpos: -1.8, boxmean: true };
        var trace2 = { y: matematica, type: 'box', name: 'Matemática', boxpoints: 'all', jitter: 0.3, pointpos: -1.8, boxmean: true };
        var trace3 = { y: sociales,   type: 'box', name: 'Sociales',   boxpoints: 'all', jitter: 0.3, pointpos: -1.8, boxmean: true };
        var trace4 = { y: cienciasN,  type: 'box', name: 'Ciencias N', boxpoints: 'all', jitter: 0.3, pointpos: -1.8, boxmean: true };
        var trace5 = { y: ingles,     type: 'box', name: 'Inglés',     boxpoints: 'all', jitter: 0.3, pointpos: -1.8, boxmean: true };
        
        var data = [trace1, trace2, trace3, trace4, trace5];
        
        // 5. Definir el layout (diseño y títulos) del gráfico
        var layout = {
            title: {
                text: 'Comparación de Puntajes por Materia',
                font: { size: 20 }
            },
            yaxis: {
                title: 'Puntajes',
                zeroline: false
            },
            showlegend: false // Ocultamos la leyenda porque los nombres ya están en el eje X
        };
        
        // 6. Dibujar el gráfico en el contenedor 'boxPlot'
        Plotly.newPlot('boxPlot', data, layout);
        
        // --- CÓDIGO PARA LA INTEGRACIÓN CON GEMINI API ---
        const geminiButton = document.getElementById('gemini-button');
        const geminiResponseContainer = document.getElementById('gemini-response');
        const loader = document.getElementById('loader');

        geminiButton.addEventListener('click', getGeminiAnalysis);

        async function getGeminiAnalysis() {
            geminiButton.disabled = true;
            geminiResponseContainer.textContent = '';
            loader.style.display = 'block';

            const systemPrompt = `Eres un analista de datos y asesor educativo experto. A continuación se presentan las puntuaciones de los estudiantes en cinco asignaturas diferentes. Tu respuesta debe estar en español.

            Basándote en estos datos, proporciona un análisis conciso y fácil de entender sobre el rendimiento general. Tu análisis debe tener dos partes:
            1.  **Resumen del Rendimiento:** Describe brevemente las observaciones clave de los datos. ¿Qué asignatura tiene las puntuaciones más altas? ¿Cuál tiene la mayor variación? ¿Hay alguna tendencia clara?
            2.  **Recomendaciones Generales:** Ofrece 3-4 recomendaciones prácticas para el profesor o los estudiantes con el fin de mejorar los resultados de aprendizaje.

            Estructura tu respuesta de forma clara con títulos para cada sección.`;

            const userQuery = `
            Datos de las asignaturas:
            - Lectura: ${JSON.stringify(lectura)}
            - Matemática: ${JSON.stringify(matematica)}
            - Sociales: ${JSON.stringify(sociales)}
            - Ciencias N: ${JSON.stringify(cienciasN)}
            - Inglés: ${JSON.stringify(ingles)}
            `;

            try {
                const generatedText = await callGeminiAPI(systemPrompt, userQuery);
                geminiResponseContainer.textContent = generatedText;
            } catch (error) {
                geminiResponseContainer.textContent = 'Error al generar el análisis. Por favor, inténtalo de nuevo más tarde.';
                console.error("Error calling Gemini API:", error);
            } finally {
                geminiButton.disabled = false;
                loader.style.display = 'none';
            }
        }

        async function callGeminiAPI(systemPrompt, userQuery, retries = 3, delay = 1000) {
            const apiKey = ""; // Canvas se encargará de la clave de API
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return candidate.content.parts[0].text;
                    } else {
                        throw new Error('Respuesta inesperada de la API o contenido vacío.');
                    }
                } catch (error) {
                    console.error(`Intento ${i + 1} fallido:`, error);
                    if (i < retries - 1) {
                        await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                    } else {
                        throw error;
                    }
                }
            }
        }
    </script>
</body>
</html>